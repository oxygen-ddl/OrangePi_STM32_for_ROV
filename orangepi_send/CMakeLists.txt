cmake_minimum_required(VERSION 3.10)
project(pwm_udp_sender LANGUAGES C CXX)

# ================== è¯­è¨€ä¸æ ‡å‡† ==================
set(CMAKE_CXX_STANDARD 17)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_C_STANDARD 11)
set(CMAKE_C_STANDARD_REQUIRED ON)

# ================== ç¼–è¯‘é€‰é¡¹ï¼ˆæ›´ç¨³æ›´ä¸¥ï¼‰ ==================
if (CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
  add_compile_options(-Wall -Wextra -Wpedantic -Wconversion -Wsign-conversion)
  add_compile_options(-Wshadow -Wformat=2 -Wundef)
  # Debug/Release é»˜è®¤ä¼˜åŒ–
  if (NOT CMAKE_BUILD_TYPE)
    set(CMAKE_BUILD_TYPE RelWithDebInfo CACHE STRING "" FORCE)
  endif()
endif()

# ä¸º clock_gettimeã€pthread ç­‰ POSIX API å¯ç”¨å®ï¼ˆæœ‰äº›å¹³å°éœ€è¦ï¼‰
add_compile_definitions(_POSIX_C_SOURCE=200809L)

# ================== æºç æ¸…å• ==================
# å»ºè®®åˆ‡æ¢åˆ° protocol_packï¼ˆä¸»æœºä¾§è½»é‡æ‰“åŒ…ï¼‰ï¼Œç§»é™¤æ—§çš„ PwmFrameBuilder/é‡å¤çš„ CRC
set(SRCS
  src/main.cpp
  src/UdpSender.cpp
  src/protocol_pack.c       # ğŸ‘ˆ æ–°å¢ï¼šä¸Šä½æœºæ‰“åŒ…ï¼ˆCï¼‰
)

# å¦‚æœä½ æš‚æ—¶è¿˜åœ¨ç”¨æ—§çš„ PwmFrameBuilderï¼Œè¯·å–æ¶ˆä¸Šé¢è¿™ä¸€è¡Œå¹¶æ”¹ç”¨ä¸‹é¢ä¸¤è¡Œï¼š
# list(APPEND SRCS src/PwmFrameBuilder.cpp src/crc16_ccitt.cpp)

add_executable(pwm_udp_sender ${SRCS})

# ================== å¤´æ–‡ä»¶è·¯å¾„ ==================
target_include_directories(pwm_udp_sender PRIVATE
  ${CMAKE_CURRENT_SOURCE_DIR}/include
  ${CMAKE_CURRENT_SOURCE_DIR}/src
)

# ================== çº¿ç¨‹ & å®æ—¶åº“ï¼ˆLinuxï¼‰ ==================
find_package(Threads REQUIRED)
target_link_libraries(pwm_udp_sender PRIVATE Threads::Threads)

# è€æ—§ç³»ç»Ÿä¸Š clock_gettime å¯èƒ½è¿˜åœ¨ librtï¼Œåšä¸€æ¬¡æ£€æŸ¥åæœ‰åˆ™é“¾æ¥
include(CheckLibraryExists)
check_library_exists(rt clock_gettime "" HAVE_LIBRT)
if (HAVE_LIBRT)
  target_link_libraries(pwm_udp_sender PRIVATE rt)
endif()

# ================== å¹³å°ç‰¹æ€§ï¼ˆLinux ä¼˜åŒ–ï¼‰ ==================
if (UNIX AND NOT APPLE)
  # ç¦æ­¢ç”Ÿæˆå¯æ‰§è¡Œæ ˆï¼Œæé«˜å®‰å…¨
  target_link_options(pwm_udp_sender PRIVATE "-Wl,-z,noexecstack")
endif()

# ================== å¯é€‰ï¼šæ›´ä¸¥æ ¼/æ›´ç¨³çš„æ„å»ºå¼€å…³ ==================
option(ENABLE_LTO "Enable link-time optimization if supported" ON)
if (ENABLE_LTO)
  include(CheckIPOSupported)
  check_ipo_supported(RESULT ipo_ok OUTPUT ipo_err)
  if (ipo_ok)
    set_property(TARGET pwm_udp_sender PROPERTY INTERPROCEDURAL_OPTIMIZATION TRUE)
  endif()
endif()

# ================== æ‰“å°æ„å»ºä¿¡æ¯ ==================
message(STATUS "Build type: ${CMAKE_BUILD_TYPE}")
message(STATUS "CXX: ${CMAKE_CXX_COMPILER_ID} ${CMAKE_CXX_COMPILER_VERSION}")
