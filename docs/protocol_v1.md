
---

# 通信协议说明书（Protocol V1）

## 1. 概述

本协议用于 **香橙派（上位机控制端）** 与 **STM32（执行控制端）** 之间的通信。
物理层通过以太网连接，但通信内容仍采用 **串口字节流格式**（模拟 UART 协议），确保兼容性与低延迟。

协议采用统一的帧结构、字节对齐和 CRC16 校验机制，支持：

* 电机 PWM 控制命令；
* 心跳包与应答；
* 后续扩展（状态回传、紧急停机、参数设置等）。

版本号：`V1.0`
发布日期：2025-11-11
作者：孙之媛，王立，王雨舒（香橙派 & STM32）

---

## 2. 数据帧总体结构

每一帧为一个完整的字节流包（不依赖网络包边界）。帧格式如下：

| 字段          | 长度（字节） | 说明                                      |
| ----------- | ------ | --------------------------------------- |
| **SOF**     | 2      | 帧头：固定为 `0xAA 0x55`                      |
| **VER**     | 1      | 协议版本号，当前为 `0x01`                        |
| **MSG_ID**  | 1      | 消息类型（详见第 3 节）                           |
| **SEQ**     | 2      | 序列号（大端，0~65535，回包需原样返回）                 |
| **TICKS**   | 4      | 发送端时间戳（毫秒，uint32，大端）                    |
| **LEN**     | 2      | 数据区长度（大端）                               |
| **PAYLOAD** | N      | 数据内容（长度由 LEN 指定）                        |
| **CRC16**   | 2      | 校验字段，CRC16-CCITT-FALSE，覆盖 VER 至 PAYLOAD |

**总长度 = 2 + 1 + 1 + 2 + 4 + 2 + LEN + 2 = 14 + LEN 字节**

### 帧头与端序

* **SOF**：固定 `0xAA55`（区分旧版帧 `0xAA 0x55` 和心跳帧 `0x55 0xAA`）
* **字节序**：多字节字段统一使用 **大端（Big Endian）**

---

## 3. 消息类型定义（MSG_ID）

| MSG_ID | 名称                | 方向           | LEN | 描述                |
| ------ | ----------------- | ------------ | --- | ----------------- |
| `0x01` | `PWM_CMD`         | Host → STM32 | 16  | 8 路 PWM 控制命令      |
| `0x10` | `HEARTBEAT`       | 双向           | 0   | 心跳包（上位机每 1 秒发送一次） |
| `0x11` | `HEARTBEAT_ACK`   | STM32 → Host | 0   | 心跳应答（SEQ 原样回写）    |
| `0x20` | `ESTOP`           | Host → STM32 | 0   | 紧急停机（立即 1500 μs）  |
| `0x30` | `PARAM_SET`       | Host → STM32 | 自定义 | 参数设置，预留扩展         |
| `0x40` | `STATUS_FEEDBACK` | STM32 → Host | 自定义 | 设备状态上报，预留扩展       |

---

## 4. 各消息详细定义

### 4.1 PWM 控制帧（MSG_ID = 0x01）

| 字节偏移  | 内容      | 类型     | 长度 | 说明               |
| ----- | ------- | ------ | -- | ---------------- |
| 0–1   | PWM_CH1 | uint16 | 2  | 通道1，占空值（0–10000） |
| 2–3   | PWM_CH2 | uint16 | 2  | 通道2              |
| 4–5   | PWM_CH3 | uint16 | 2  | 通道3              |
| 6–7   | PWM_CH4 | uint16 | 2  | 通道4              |
| 8–9   | PWM_CH5 | uint16 | 2  | 通道5              |
| 10–11 | PWM_CH6 | uint16 | 2  | 通道6              |
| 12–13 | PWM_CH7 | uint16 | 2  | 通道7              |
| 14–15 | PWM_CH8 | uint16 | 2  | 通道8              |

**取值范围：**

* 0 → 1000 μs（反推）
* 5000 → 1500 μs（中立）
* 10000 → 2000 μs（正推）

**例：**

```text
AA 55 01 01 00 10 00 00 00 00 00 10
00 00 13 88 27 10 3A 98 4E 20 61 A8 75 30 88 B8 9C 40 A2 2A
```

---

### 4.2 心跳帧（MSG_ID = 0x10）

上位机每秒发送一次空负载心跳：

```
AA 55 01 10 00 00 12 34 56 78 00 00 CRC_H CRC_L
```

STM32 收到后立即回 `0x11` 帧，SEQ 原样回写：

```
AA 55 01 11 00 00 12 34 56 78 00 00 CRC_H CRC_L
```

---

### 4.3 紧急停机（MSG_ID = 0x20）

STM32 立即将所有通道置中（1500 μs），并锁死 500 ms。
此命令无需应答。

---

## 5. 校验算法（CRC16-CCITT-FALSE）

* **多项式**：0x1021
* **初始值**：0xFFFF
* **输入/输出不反转**
* **最终异或值**：0x0000

### 计算范围

从 `VER`（偏移 2）到 `PAYLOAD` 最后一个字节，**不含 SOF 与 CRC 自身**。

### 示例（C 代码）

```c
uint16_t crc16_ccitt(const uint8_t *data, uint16_t len)
{
    uint16_t crc = 0xFFFF;
    for (uint16_t i = 0; i < len; i++) {
        crc ^= (uint16_t)data[i] << 8;
        for (uint8_t j = 0; j < 8; j++) {
            crc = (crc & 0x8000) ? (crc << 1) ^ 0x1021 : (crc << 1);
        }
    }
    return crc;
}
```

---

## 6. 时序与通信策略

| 项目     | 建议值          | 说明            |
| ------ | ------------ | ------------- |
| 控制频率   | 50–100 Hz    | 上位机发送 PWM_CMD |
| 心跳周期   | 1 s          | 检测链路存活        |
| 超时判定   | 300 ms       | STM32 超时回中位   |
| ACK 超时 | 100 ms       | 心跳未回 ACK 可重发  |
| 丢包策略   | 丢弃非法帧，不缓存不重组 |               |

---

## 7. 错误与容错机制

STM32 对接收帧执行如下校验顺序：

1. 帧头合法性（`0xAA55`）；
2. 版本匹配（`VER=0x01`）；
3. 长度与缓冲区安全性；
4. CRC16 校验；
5. 消息类型判断。

任一失败即丢弃该帧，并计入错误统计：

```c
typedef struct {
    uint32_t rx_ok;
    uint32_t rx_crc_err;
    uint32_t rx_len_err;
    uint32_t rx_unsupported;
} proto_stats_t;
```

---

## 8. 对应控制逻辑（STM32 端）

| 状态               | 行为                                         |
| ---------------- | ------------------------------------------ |
| 接收到合法 PWM_CMD    | 调用 `Driver_pwm_Apply8_0_10000()` 更新 8 通道输出 |
| 接收到 HEARTBEAT    | 调用 `Uart5_Send()` 回发 ACK                   |
| 超过 300 ms 未收到有效帧 | 调用 `Driver_pwm_ApplyMidAll()` 回中位          |
| 接收到 ESTOP        | 立即中位，关闭定时器更新中断                             |
| 其他 MSG_ID        | 计入 `rx_unsupported`                        |

---

## 9. 示例交互流程

```
Host (香橙派)                STM32
    │                            │
    │---- PWM_CMD 50Hz --------->│  更新 8 路 PWM
    │                            │
    │---- HEARTBEAT 1Hz -------->│
    │                            │---- HEARTBEAT_ACK ---->│
    │                            │
(掉线 >300ms)
    │                            │---- 回中位 (failsafe)
```

---

## 10. 后续扩展（建议预留）

| ID     | 名称              | 方向         | 说明                   |
| ------ | --------------- | ---------- | -------------------- |
| `0x30` | PARAM_SET       | 双向         | 上位机修改控制参数、PID、Q、R 等  |
| `0x40` | STATUS_FEEDBACK | STM32→Host | 返回 PWM、温度、电压、IMU 状态等 |
| `0x50` | MOTOR_DIAG      | STM32→Host | 推进器自检、异常告警           |

---

## 11. 文件放置建议

| 文件                 | 作用            | 建议路径                                          |
| ------------------ | ------------- | --------------------------------------------- |
| `protocol_v1.h/.c` | 协议实现代码（STM32） | `Source/Inc/protocol/`、`Source/Src/protocol/` |
| `crc16_ccitt.h/.c` | CRC 算法        | 同上                                            |
| `Protocol_V1.md`   | 本文档           | `docs/Protocol_V1.md`                         |

---

## 12. 附录：字段示例（十六进制）

以 `PWM_CMD` 为例（8 通道全 5000）：

| 字段      | 数据          | 说明      |
| ------- | ----------- | ------- |
| SOF     | AA 55       | 帧头      |
| VER     | 01          | 版本      |
| MSG_ID  | 01          | PWM_CMD |
| SEQ     | 00 01       | 序列号=1   |
| TICKS   | 00 00 01 F4 | 500 ms  |
| LEN     | 00 10       | 数据长 16  |
| PAYLOAD | 13 88 × 8   | 5000*8  |
| CRC16   | 12 34       | 示例值     |

---

✅ **总结**
此协议版本 (`V1`) 提供了：

* 统一帧结构与 CRC 校验；
* 双向心跳机制；
* 明确的 8 路 PWM 映射；
* 失联保护与紧急停机；
* 清晰的扩展空间。

---
